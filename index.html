<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>EVERYTINROOM POS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#f1f5f9;color:#1e293b;min-height:100vh}
:root{--blue:#3b82f6;--green:#22c55e;--red:#ef4444;--orange:#f59e0b}
#loader{position:fixed;inset:0;background:linear-gradient(135deg,#3b82f6,#8b5cf6);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
#loader.hidden{display:none}
.spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader p{color:#fff;font-weight:600}
#toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:12px 24px;border-radius:8px;font-weight:500;z-index:9999;opacity:0;transition:0.3s}
#toast.show{opacity:1}
#toast.success{background:#22c55e}
#toast.error{background:#ef4444}
#loginPage{position:fixed;inset:0;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;padding:20px;z-index:1000}
#loginPage.hidden{display:none}
.login-card{background:#fff;border-radius:24px;padding:40px 32px;width:100%;max-width:360px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.login-card h1{font-size:28px;margin-bottom:8px;color:#3b82f6}
.login-card p{color:#64748b;margin-bottom:32px}
.pin-inputs{display:flex;gap:12px;justify-content:center;margin-bottom:24px}
.pin-inputs input{width:56px;height:64px;border:2px solid #e2e8f0;border-radius:12px;font-size:24px;font-weight:700;text-align:center}
.pin-inputs input:focus{outline:none;border-color:#3b82f6}
#loginError{color:#ef4444;font-size:14px;display:none}
#loginError.show{display:block}
#app{display:none;min-height:100vh}
#app.show{display:block}
.header{position:fixed;top:0;left:0;right:0;height:60px;background:#fff;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;padding:0 16px;gap:12px;z-index:100}
.header h1{font-size:18px;font-weight:800;color:#3b82f6}
.header-spacer{flex:1}
.header-btn{width:40px;height:40px;border:none;background:#f1f5f9;border-radius:10px;font-size:18px;cursor:pointer;position:relative}
.header-badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:#ef4444;color:#fff;border-radius:9px;font-size:10px;display:flex;align-items:center;justify-content:center}
.nav{position:fixed;bottom:0;left:0;right:0;height:70px;background:#fff;border-top:1px solid #e2e8f0;display:flex;z-index:100}
.nav button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;border:none;background:none;color:#94a3b8;font-size:10px;font-weight:600;cursor:pointer}
.nav button span{font-size:24px}
.nav button.active{color:#3b82f6}
.main{padding:76px 16px 86px}
.page{display:none}
.page.active{display:block}
.card{background:#fff;border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.stat-card .icon{font-size:24px;margin-bottom:8px}
.stat-card .label{font-size:11px;color:#64748b;text-transform:uppercase;font-weight:600}
.stat-card .value{font-size:24px;font-weight:800}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;border:none;cursor:pointer}
.btn-blue{background:#3b82f6;color:#fff}
.btn-green{background:#22c55e;color:#fff}
.btn-red{background:#ef4444;color:#fff}
.btn-gray{background:#f1f5f9;color:#64748b}
.btn-sm{padding:8px 12px;font-size:12px}
.btn-full{width:100%}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px}
.form-input{width:100%;height:48px;padding:0 16px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px}
.form-input:focus{outline:none;border-color:#3b82f6}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.search-box{position:relative;margin-bottom:16px}
.search-box input{width:100%;height:48px;padding:0 16px 0 44px;border:2px solid #e2e8f0;border-radius:12px;font-size:15px}
.search-box input:focus{outline:none;border-color:#3b82f6}
.search-box::before{content:'ğŸ”';position:absolute;left:14px;top:50%;transform:translateY(-50%)}
.products-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.product-card{background:#fff;border-radius:12px;padding:12px;cursor:pointer;border:2px solid transparent;transition:0.2s}
.product-card:hover{border-color:#3b82f6}
.product-card.disabled{opacity:0.4;pointer-events:none}
.product-img{height:80px;background:#f1f5f9;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:32px;margin-bottom:8px;overflow:hidden}
.product-img img{width:100%;height:100%;object-fit:cover}
.product-name{font-size:13px;font-weight:600;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.product-price{font-size:16px;font-weight:800;color:#3b82f6}
.product-stock{font-size:11px;margin-top:4px}
.stock-ok{color:#22c55e}
.stock-low{color:#f59e0b}
.stock-out{color:#ef4444}
.mode-tabs{display:flex;gap:8px;margin-bottom:16px}
.mode-tab{flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:10px;background:#fff;font-size:12px;font-weight:700;color:#94a3b8;cursor:pointer;text-align:center}
.mode-tab.active{border-color:#3b82f6;color:#3b82f6}
.cat-pills{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:16px}
.cat-pill{padding:8px 16px;background:#fff;border:2px solid #e2e8f0;border-radius:20px;font-size:12px;font-weight:600;color:#64748b;white-space:nowrap;cursor:pointer}
.cat-pill.active{background:#3b82f6;border-color:#3b82f6;color:#fff}
.cart-fab{position:fixed;bottom:86px;right:16px;width:56px;height:56px;background:#3b82f6;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;box-shadow:0 4px 20px rgba(59,130,246,0.4);cursor:pointer;border:none;z-index:99}
.cart-fab .badge{position:absolute;top:-4px;right:-4px;min-width:22px;height:22px;background:#ef4444;border-radius:11px;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center}
#cartOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;opacity:0;pointer-events:none;transition:0.3s}
#cartOverlay.show{opacity:1;pointer-events:auto}
#cartDrawer{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:24px 24px 0 0;max-height:85vh;z-index:201;transform:translateY(100%);transition:0.3s;display:flex;flex-direction:column}
#cartDrawer.show{transform:translateY(0)}
.cart-header{padding:20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
.cart-header h3{font-size:18px}
.cart-body{flex:1;overflow-y:auto;padding:16px;max-height:40vh}
.cart-item{display:flex;align-items:center;gap:12px;padding:12px;background:#f8fafc;border-radius:12px;margin-bottom:8px}
.cart-item-img{width:44px;height:44px;background:#e2e8f0;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.cart-item-info{flex:1}
.cart-item-name{font-weight:600;font-size:14px}
.cart-item-price{font-size:12px;color:#64748b}
.cart-item-qty{display:flex;align-items:center;gap:8px}
.cart-item-qty button{width:32px;height:32px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;font-size:16px;cursor:pointer}
.cart-item-qty span{font-weight:700;min-width:24px;text-align:center}
.cart-item-del{width:32px;height:32px;background:#fee2e2;border:none;border-radius:8px;color:#ef4444;cursor:pointer}
.cart-empty{text-align:center;padding:40px;color:#94a3b8}
.cart-footer{padding:16px;border-top:1px solid #e2e8f0;background:#f8fafc}
.cart-row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}
.cart-row.total{font-size:18px;font-weight:800;padding-top:8px;border-top:2px dashed #e2e8f0}
.cart-row.total .val{color:#3b82f6}
.cart-discount{width:80px;height:36px;padding:0 8px;border:1px solid #e2e8f0;border-radius:8px;text-align:right}
.cart-phone{width:100%;height:44px;padding:0 12px;border:1px solid #e2e8f0;border-radius:8px;margin:12px 0}
.modal{position:fixed;inset:0;z-index:300;display:none;align-items:flex-end;justify-content:center}
.modal.show{display:flex}
.modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.5)}
.modal-content{position:relative;background:#fff;border-radius:24px 24px 0 0;width:100%;max-height:90vh;display:flex;flex-direction:column}
.modal-header{padding:20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
.modal-header h3{font-size:18px;font-weight:700}
.modal-close{width:36px;height:36px;background:#f1f5f9;border:none;border-radius:10px;font-size:20px;cursor:pointer}
.modal-body{flex:1;overflow-y:auto;padding:20px}
.modal-footer{padding:16px 20px;border-top:1px solid #e2e8f0;display:flex;gap:12px}
.table-wrap{overflow-x:auto;margin:0 -20px;padding:0 20px}
table{width:100%;border-collapse:collapse;min-width:400px}
th{text-align:left;padding:12px 8px;background:#f8fafc;font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase}
td{padding:12px 8px;border-bottom:1px solid #f1f5f9;font-size:13px}
.empty-state{text-align:center;padding:48px 20px;color:#94a3b8}
.empty-state span{font-size:48px;display:block;margin-bottom:12px}
.badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:700}
.badge-green{background:#dcfce7;color:#22c55e}
.badge-orange{background:#fef3c7;color:#f59e0b}
.badge-red{background:#fee2e2;color:#ef4444}
.badge-blue{background:#dbeafe;color:#3b82f6}
.hero-card{padding:24px;border-radius:16px;color:#fff;margin-bottom:20px}
.hero-card.green{background:linear-gradient(135deg,#22c55e,#16a34a)}
.hero-card.blue{background:linear-gradient(135deg,#3b82f6,#2563eb)}
.hero-card.red{background:linear-gradient(135deg,#ef4444,#dc2626)}
.hero-card .label{font-size:14px;opacity:0.9}
.hero-card .value{font-size:32px;font-weight:800;margin-top:4px}
.img-upload{width:100%;height:120px;border:2px dashed #e2e8f0;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;margin-bottom:16px;background:#f8fafc;overflow:hidden}
.img-upload.has-image{border-style:solid;border-color:#22c55e}
.img-upload img{width:100%;height:100%;object-fit:cover}
.img-upload span{font-size:32px}
.img-upload p{font-size:12px;color:#94a3b8;margin-top:4px}
.wa-order{background:#fff;border-radius:16px;padding:16px;margin-bottom:12px;border-left:4px solid #22c55e;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.wa-order.completed{border-left-color:#94a3b8;opacity:0.6}
.wa-order-header{display:flex;justify-content:space-between;margin-bottom:12px}
.wa-order-id{font-weight:700}
.wa-order-time{font-size:12px;color:#94a3b8}
.wa-order-customer{display:flex;align-items:center;gap:12px;padding:12px;background:#f8fafc;border-radius:10px;margin-bottom:12px}
.wa-order-avatar{width:40px;height:40px;background:#22c55e;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px}
.wa-order-items{margin-bottom:12px}
.wa-order-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #e2e8f0;font-size:13px}
.wa-order-total{font-size:20px;font-weight:800;color:#3b82f6}
.wa-order-actions{display:flex;gap:8px}
#printArea{display:none}
@media print{body *{visibility:hidden}#printArea,#printArea *{visibility:visible}#printArea{display:block;position:fixed;top:0;left:0;width:80mm;padding:4mm;background:#fff}}
@media(min-width:640px){.products-grid{grid-template-columns:repeat(3,1fr)}.stats{grid-template-columns:repeat(4,1fr)}}
@media(min-width:1024px){.products-grid{grid-template-columns:repeat(4,1fr)}}
</style>
</head>
<body>
<div id="loader"><div class="spinner"></div><p id="loaderText">Loading...</p></div>
<div id="toast"></div>
<div id="loginPage">
<div class="login-card">
<h1>ğŸ›’ EVERYTINROOM</h1>
<p>Enter your PIN to continue</p>
<div class="pin-inputs">
<input type="tel" maxlength="1" id="pin1" oninput="handlePin(1)">
<input type="tel" maxlength="1" id="pin2" oninput="handlePin(2)">
<input type="tel" maxlength="1" id="pin3" oninput="handlePin(3)">
<input type="tel" maxlength="1" id="pin4" oninput="handlePin(4)">
</div>
<p id="loginError">Invalid PIN. Try again.</p>
</div>
</div>
<div id="app">
<header class="header">
<h1>ğŸ›’ EVERYTINROOM</h1>
<div class="header-spacer"></div>
<button class="header-btn" onclick="navigate('whatsapp')">ğŸ“±<span class="header-badge" id="waBadgeHeader">0</span></button>
<button class="header-btn" onclick="navigate('dashboard')">â˜°</button>
</header>
<nav class="nav">
<button class="active" data-page="pos" onclick="navigate('pos')"><span>ğŸ›’</span>POS</button>
<button data-page="whatsapp" onclick="navigate('whatsapp')"><span>ğŸ“±</span>Orders</button>
<button data-page="receipts" onclick="navigate('receipts')"><span>ğŸ§¾</span>Receipts</button>
<button data-page="dashboard" onclick="navigate('dashboard')"><span>ğŸ“Š</span>More</button>
</nav>
<button class="cart-fab" onclick="openCart()">ğŸ›’<span class="badge" id="cartBadge">0</span></button>
<main class="main">
<section class="page" id="pageDashboard">
<h2 style="font-size:24px;margin-bottom:16px">ğŸ“Š Dashboard</h2>
<div class="stats">
<div class="stat-card"><div class="icon">ğŸ’°</div><div class="label">Today Sales</div><div class="value" id="statSales">GHS 0</div></div>
<div class="stat-card"><div class="icon">ğŸ“ˆ</div><div class="label">Profit</div><div class="value" id="statProfit">GHS 0</div></div>
<div class="stat-card"><div class="icon">ğŸ“±</div><div class="label">Pending</div><div class="value" id="statPending">0</div></div>
<div class="stat-card"><div class="icon">âš ï¸</div><div class="label">Low Stock</div><div class="value" id="statLowStock">0</div></div>
</div>
<div class="card">
<h3 style="margin-bottom:12px">Quick Links</h3>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
<button class="btn btn-gray btn-full" onclick="navigate('products')">ğŸ“¦ Products</button>
<button class="btn btn-gray btn-full" onclick="navigate('bundles')">ğŸ Bundles</button>
<button class="btn btn-gray btn-full" onclick="navigate('expenses')">ğŸ’¸ Expenses</button>
<button class="btn btn-gray btn-full" onclick="navigate('reports')">ğŸ“ˆ Reports</button>
<button class="btn btn-gray btn-full" onclick="navigate('customers')">ğŸ‘¥ Customers</button>
<button class="btn btn-gray btn-full" onclick="navigate('staff')">ğŸ‘¤ Staff</button>
</div>
</div>
<div class="card"><h3 style="margin-bottom:12px">âš ï¸ Low Stock Items</h3><div id="lowStockList"></div></div>
</section>
<section class="page active" id="pagePOS">
<div class="search-box"><input type="text" placeholder="Search products..." id="searchProducts" oninput="renderProducts()"></div>
<div class="cat-pills" id="categoryPills"></div>
<div class="mode-tabs">
<button class="mode-tab active" data-mode="retail" onclick="setMode('retail')">ğŸ›ï¸ Retail</button>
<button class="mode-tab" data-mode="wholesale" onclick="setMode('wholesale')">ğŸ“¦ Wholesale</button>
<button class="mode-tab" data-mode="bundle" onclick="setMode('bundle')">ğŸ Bundle</button>
</div>
<div class="products-grid" id="productsGrid"></div>
</section>
<section class="page" id="pageWhatsApp">
<h2 style="font-size:24px;margin-bottom:16px">ğŸ“± WhatsApp Orders</h2>
<div class="hero-card green"><div class="label">Pending Orders</div><div class="value" id="pendingCount">0</div></div>
<div class="cat-pills" style="margin-bottom:16px">
<button class="cat-pill active" onclick="filterOrders('Pending')">ğŸŸ¢ Pending</button>
<button class="cat-pill" onclick="filterOrders('Completed')">âœ… Completed</button>
<button class="cat-pill" onclick="filterOrders('all')">All</button>
</div>
<div id="ordersList"></div>
</section>
<section class="page" id="pageReceipts">
<h2 style="font-size:24px;margin-bottom:16px">ğŸ§¾ Receipts</h2>
<div class="search-box"><input type="text" placeholder="Search receipts..." id="searchReceipts" oninput="renderReceipts()"></div>
<div class="card"><div class="table-wrap"><table><thead><tr><th>Receipt</th><th>Date</th><th>Total</th><th></th></tr></thead><tbody id="receiptsTable"></tbody></table></div></div>
</section>
<section class="page" id="pageProducts">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:24px">ğŸ“¦ Products</h2>
<button class="btn btn-blue" onclick="openProductModal()">â• Add</button>
</div>
<div class="search-box"><input type="text" placeholder="Search..." id="searchProductsList" oninput="renderProductsList()"></div>
<div class="card"><div class="table-wrap"><table><thead><tr><th></th><th>Name</th><th>Price</th><th>Stock</th><th></th></tr></thead><tbody id="productsTable"></tbody></table></div></div>
</section>
<section class="page" id="pageBundles">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:24px">ğŸ Bundles</h2>
<button class="btn btn-blue" onclick="openBundleModal()">â• Create</button>
</div>
<div class="card"><div class="table-wrap"><table><thead><tr><th>Name</th><th>Items</th><th>Price</th><th></th></tr></thead><tbody id="bundlesTable"></tbody></table></div></div>
</section>
<section class="page" id="pageCustomers">
<h2 style="font-size:24px;margin-bottom:16px">ğŸ‘¥ Customers</h2>
<div class="stats">
<div class="stat-card"><div class="icon">ğŸ‘¥</div><div class="label">Total</div><div class="value" id="custTotal">0</div></div>
<div class="stat-card"><div class="icon">ğŸ”„</div><div class="label">Repeat</div><div class="value" id="custRepeat">0</div></div>
<div class="stat-card"><div class="icon">ğŸ’°</div><div class="label">Revenue</div><div class="value" id="custRevenue">GHS 0</div></div>
<div class="stat-card"><div class="icon">ğŸ“Š</div><div class="label">Avg Spend</div><div class="value" id="custAvg">GHS 0</div></div>
</div>
<div class="card"><div class="search-box"><input type="text" placeholder="Search..." id="searchCustomers" oninput="renderCustomers()"></div><div class="table-wrap"><table><thead><tr><th>Phone</th><th>Visits</th><th>Total Spent</th><th>Last Visit</th></tr></thead><tbody id="customersTable"></tbody></table></div></div>
</section>
<section class="page" id="pageExpenses">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:24px">ğŸ’¸ Expenses</h2>
<button class="btn btn-red" onclick="openExpenseModal()">â• Add</button>
</div>
<div class="hero-card red"><div class="label">This Month</div><div class="value" id="expenseMonth">GHS 0</div></div>
<div class="card"><div class="table-wrap"><table><thead><tr><th>Date</th><th>Category</th><th>Amount</th><th></th></tr></thead><tbody id="expensesTable"></tbody></table></div></div>
</section>
<section class="page" id="pageReports">
<h2 style="font-size:24px;margin-bottom:16px">ğŸ“ˆ Reports</h2>
<div class="form-row" style="margin-bottom:16px">
<div class="form-group"><label class="form-label">From</label><input type="date" class="form-input" id="reportFrom" onchange="loadReports()"></div>
<div class="form-group"><label class="form-label">To</label><input type="date" class="form-input" id="reportTo" onchange="loadReports()"></div>
</div>
<div class="stats">
<div class="stat-card"><div class="label">Sales</div><div class="value" id="repSales">GHS 0</div></div>
<div class="stat-card"><div class="label">Profit</div><div class="value" style="color:#22c55e" id="repProfit">GHS 0</div></div>
<div class="stat-card"><div class="label">Expenses</div><div class="value" style="color:#ef4444" id="repExpenses">GHS 0</div></div>
<div class="stat-card"><div class="label">Net</div><div class="value" id="repNet">GHS 0</div></div>
</div>
<div class="card"><h3 style="margin-bottom:12px">ğŸ† Top Products</h3><div id="topProducts"></div></div>
</section>
<section class="page" id="pageStaff">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:24px">ğŸ‘¤ Staff</h2>
<button class="btn btn-blue" onclick="openStaffModal()">â• Add</button>
</div>
<div class="card"><div class="table-wrap"><table><thead><tr><th>Name</th><th>Role</th><th></th></tr></thead><tbody id="staffTable"></tbody></table></div></div>
</section>
</main>
</div>
<div id="cartOverlay" onclick="closeCart()"></div>
<div id="cartDrawer">
<div class="cart-header"><h3>ğŸ›’ Cart (<span id="cartCount">0</span>)</h3><div style="display:flex;gap:8px"><button class="btn btn-gray btn-sm" onclick="clearCart()">ğŸ—‘ï¸</button></div></div>
<div class="cart-body" id="cartBody"><div class="cart-empty"><span>ğŸ›’</span><p>Your cart is empty</p></div></div>
<div class="cart-footer">
<div class="cart-row"><span>Subtotal</span><span id="cartSubtotal">GHS 0</span></div>
<div class="cart-row"><span>Discount</span><input type="number" class="cart-discount" id="cartDiscount" value="0" min="0" oninput="updateCartTotals()"></div>
<div class="cart-row total"><span>Total</span><span class="val" id="cartTotal">GHS 0</span></div>
<input type="tel" class="cart-phone" placeholder="ğŸ“± Customer phone (optional)" id="cartPhone">
<button class="btn btn-green btn-full" id="checkoutBtn" onclick="openPaymentModal()" disabled>âœ… Checkout</button>
</div>
</div>
<div class="modal" id="paymentModal">
<div class="modal-overlay" onclick="closeModal('paymentModal')"></div>
<div class="modal-content">
<div class="modal-header"><h3>ğŸ’³ Payment</h3><button class="modal-close" onclick="closeModal('paymentModal')">âœ•</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Payment Method</label><select class="form-input" id="paymentMethod"><option value="Cash">ğŸ’µ Cash</option><option value="Momo">ğŸ“± Mobile Money</option><option value="Card">ğŸ’³ Card</option></select></div>
<div class="hero-card blue" style="margin-top:16px"><div class="label">Amount to Pay</div><div class="value" id="paymentTotal">GHS 0</div></div>
</div>
<div class="modal-footer"><button class="btn btn-green btn-full" onclick="completeSale()">âœ… Complete Sale</button></div>
</div>
</div>
<div class="modal" id="productModal">
<div class="modal-overlay" onclick="closeModal('productModal')"></div>
<div class="modal-content">
<div class="modal-header"><h3 id="productModalTitle">Add Product</h3><button class="modal-close" onclick="closeModal('productModal')">âœ•</button></div>
<div class="modal-body">
<input type="hidden" id="editProductId">
<div class="img-upload" id="imageUpload" onclick="document.getElementById('imageInput').click()"><span id="imageIcon">ğŸ“·</span><p id="imageText">Click to upload</p><img id="imagePreview" style="display:none"></div>
<input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(this)" style="display:none">
<div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="productName"></div>
<div class="form-group"><label class="form-label">Category</label><input type="text" class="form-input" id="productCategory"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Cost Price</label><input type="number" class="form-input" id="productCost" min="0"></div>
<div class="form-group"><label class="form-label">Sell Price *</label><input type="number" class="form-input" id="productPrice" min="0"></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Wholesale</label><input type="number" class="form-input" id="productWholesale" min="0"></div>
<div class="form-group"><label class="form-label">Stock *</label><input type="number" class="form-input" id="productStock" min="0"></div>
</div>
</div>
<div class="modal-footer"><button class="btn btn-gray" onclick="closeModal('productModal')">Cancel</button><button class="btn btn-blue" onclick="saveProduct()">ğŸ’¾ Save</button></div>
</div>
</div>
<div class="modal" id="bundleModal">
<div class="modal-overlay" onclick="closeModal('bundleModal')"></div>
<div class="modal-content">
<div class="modal-header"><h3>ğŸ Create Bundle</h3><button class="modal-close" onclick="closeModal('bundleModal')">âœ•</button></div>
<div class="modal-body">
<input type="hidden" id="editBundleId">
<div class="form-group"><label class="form-label">Bundle Name *</label><input type="text" class="form-input" id="bundleName"></div>
<div class="form-group"><label class="form-label">Bundle Price *</label><input type="number" class="form-input" id="bundlePrice" min="0"></div>
<div class="form-group"><label class="form-label">Add Products</label><select class="form-input" id="bundleProductSelect" onchange="addBundleProduct()"><option value="">Select product...</option></select></div>
<div class="form-group"><label class="form-label">Bundle Items</label><div id="bundleItemsList" style="background:#f8fafc;border-radius:10px;padding:12px;min-height:60px"></div></div>
</div>
<div class="modal-footer"><button class="btn btn-gray" onclick="closeModal('bundleModal')">Cancel</button><button class="btn btn-blue" onclick="saveBundle()">ğŸ’¾ Save</button></div>
</div>
</div>
<div class="modal" id="expenseModal">
<div class="modal-overlay" onclick="closeModal('expenseModal')"></div>
<div class="modal-content">
<div class="modal-header"><h3>ğŸ’¸ Add Expense</h3><button class="modal-close" onclick="closeModal('expenseModal')">âœ•</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="expenseDate"></div>
<div class="form-group"><label class="form-label">Category</label><select class="form-input" id="expenseCategory"><option>Utilities</option><option>Rent</option><option>Supplies</option><option>Transport</option><option>Salaries</option><option>Other</option></select></div>
<div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="expenseDesc"></div>
<div class="form-group"><label class="form-label">Amount *</label><input type="number" class="form-input" id="expenseAmount" min="0"></div>
</div>
<div class="modal-footer"><button class="btn btn-gray" onclick="closeModal('expenseModal')">Cancel</button><button class="btn btn-red" onclick="saveExpense()">ğŸ’¸ Add Expense</button></div>
</div>
</div>
<div class="modal" id="staffModal">
<div class="modal-overlay" onclick="closeModal('staffModal')"></div>
<div class="modal-content">
<div class="modal-header"><h3>ğŸ‘¤ Staff</h3><button class="modal-close" onclick="closeModal('staffModal')">âœ•</button></div>
<div class="modal-body">
<input type="hidden" id="editStaffId">
<div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="staffName"></div>
<div class="form-group"><label class="form-label">Role</label><select class="form-input" id="staffRole"><option>Cashier</option><option>Admin</option></select></div>
<div class="form-group"><label class="form-label">PIN (4 digits) *</label><input type="tel" class="form-input" id="staffPin" maxlength="4"></div>
</div>
<div class="modal-footer"><button class="btn btn-gray" onclick="closeModal('staffModal')">Cancel</button><button class="btn btn-blue" onclick="saveStaff()">ğŸ’¾ Save</button></div>
</div>
</div>
<div id="printArea"><div id="receiptPrint"></div></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://ecapderlhxixqusvmoio.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjYXBkZXJsaHhpeHF1c3Ztb2lvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NTMyNTEsImV4cCI6MjA4NTEyOTI1MX0.mVFLrOnm53h3f36gjjDtXpaMFGeNg3q102EavkBzVVQ';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let DATA={products:[],bundles:[],sales:[],staff:[],expenses:[],orders:[],customers:[]};
let currentUser=null,isAdmin=false,cart=[],saleMode='retail',selectedCategory='all',orderFilter='Pending',currentImage='',existingImage='',bundleProducts=[];
const $=id=>document.getElementById(id);
const num=v=>parseFloat(v)||0;
const money=v=>'GHS '+num(v).toFixed(2);
const today=()=>new Date().toISOString().split('T')[0];
const formatDate=d=>d?new Date(d).toLocaleDateString():'-';
const formatDateTime=d=>d?new Date(d).toLocaleString():'-';
function showLoader(t){$('loaderText').textContent=t||'Loading...';$('loader').classList.remove('hidden')}
function hideLoader(){$('loader').classList.add('hidden')}
function toast(m,t=''){const e=$('toast');e.textContent=m;e.className='show'+(t?' '+t:'');setTimeout(()=>e.className='',3000)}
function openModal(id){$(id).classList.add('show')}
function closeModal(id){$(id).classList.remove('show')}
function navigate(page){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));const el=$('page'+page.charAt(0).toUpperCase()+page.slice(1));if(el)el.classList.add('active');document.querySelectorAll(`.nav button[data-page="${page}"]`).forEach(b=>b.classList.add('active'));if(page==='reports')initReports();if(page==='customers')renderCustomers()}
function handlePin(n){const c=$('pin'+n);if(c.value.length===1&&n<4)$('pin'+(n+1)).focus();if(n===4&&c.value.length===1)attemptLogin()}
function attemptLogin(){const pin=$('pin1').value+$('pin2').value+$('pin3').value+$('pin4').value;if(pin==='1024'){currentUser={name:'Master',role:'Admin'};isAdmin=true;loginSuccess();return}const s=DATA.staff.find(x=>x.pin===pin&&x.active);if(s){currentUser=s;isAdmin=s.role==='Admin';loginSuccess()}else{$('loginError').classList.add('show');clearPins();setTimeout(()=>$('loginError').classList.remove('show'),2000)}}
function clearPins(){for(let i=1;i<=4;i++)$('pin'+i).value='';$('pin1').focus()}
function loginSuccess(){$('loginPage').classList.add('hidden');$('app').classList.add('show');toast('Welcome, '+currentUser.name+'!','success');navigate(isAdmin?'dashboard':'pos')}
async function loadAllData(){showLoader('Loading...');try{const[pr,st,sa,ex,bu,wo,cu]=await Promise.all([supabase.from('products').select('*').order('name'),supabase.from('staff').select('*').eq('active',true),supabase.from('sales').select('*,sale_items(*)').order('sale_date',{ascending:false}).limit(100),supabase.from('expenses').select('*').order('expense_date',{ascending:false}),supabase.from('bundles').select('*,bundle_items(*,products(*))').order('name'),supabase.from('whatsapp_orders').select('*,whatsapp_order_items(*)').order('order_date',{ascending:false}),supabase.from('customers').select('*').order('total_spent',{ascending:false})]);DATA.products=pr.data||[];DATA.staff=st.data||[];DATA.sales=sa.data||[];DATA.expenses=ex.data||[];DATA.bundles=bu.data||[];DATA.orders=wo.data||[];DATA.customers=cu.data||[];hideLoader();renderAll();$('pin1').focus()}catch(e){hideLoader();console.error(e);toast('Failed to load data','error')}}
function renderAll(){renderDashboard();renderProducts();renderCategories();renderReceipts();renderProductsList();renderBundles();renderStaff();renderExpenses();renderOrders();renderCustomers();updateOrderBadge()}
function renderDashboard(){const t=today();const ts=DATA.sales.filter(s=>s.sale_date&&s.sale_date.startsWith(t)&&!s.voided);$('statSales').textContent=money(ts.reduce((a,s)=>a+num(s.total),0));$('statProfit').textContent=money(ts.reduce((a,s)=>a+num(s.profit),0));$('statPending').textContent=DATA.orders.filter(o=>o.status==='Pending').length;const low=DATA.products.filter(p=>num(p.quantity)<=5);$('statLowStock').textContent=low.length;$('lowStockList').innerHTML=low.length?low.slice(0,10).map(p=>`<div style="display:flex;justify-content:space-between;padding:10px;background:#f8fafc;border-radius:8px;margin-bottom:6px"><span>${p.name}</span><span style="font-weight:700;color:${num(p.quantity)===0?'#ef4444':'#f59e0b'}">${p.quantity}</span></div>`).join(''):'<p style="color:#94a3b8;text-align:center">All stock levels OK</p>'}
function renderCategories(){const cats=[...new Set(DATA.products.map(p=>p.category).filter(Boolean))].sort();$('categoryPills').innerHTML=`<button class="cat-pill ${selectedCategory==='all'?'active':''}" onclick="setCategory('all')">All</button>`+cats.map(c=>`<button class="cat-pill ${selectedCategory===c?'active':''}" onclick="setCategory('${c}')">${c}</button>`).join('')}
function setCategory(c){selectedCategory=c;renderCategories();renderProducts()}
function setMode(m){saleMode=m;document.querySelectorAll('.mode-tab').forEach(t=>t.classList.toggle('active',t.dataset.mode===m));renderProducts()}
function renderProducts(){const q=($('searchProducts')?.value||'').toLowerCase();let html='';if(saleMode==='bundle'){DATA.bundles.filter(b=>b.active&&b.name.toLowerCase().includes(q)).forEach(b=>{html+=`<div class="product-card" onclick="addBundleToCart('${b.id}')"><div class="product-img">ğŸ</div><div class="product-name">${b.name}</div><div class="product-price">${money(b.bundle_price)}</div><div class="product-stock stock-ok">Bundle</div></div>`})}else{DATA.products.filter(p=>p.name.toLowerCase().includes(q)&&(selectedCategory==='all'||p.category===selectedCategory)).forEach(p=>{const pr=saleMode==='wholesale'&&num(p.wholesale_price)>0?p.wholesale_price:p.price;const qty=num(p.quantity);const sc=qty===0?'stock-out':qty<=5?'stock-low':'stock-ok';const img=p.image_url?`<img src="${p.image_url}">`:'ğŸ“¦';html+=`<div class="product-card ${qty===0?'disabled':''}" onclick="addToCart('${p.id}')"><div class="product-img">${img}</div><div class="product-name">${p.name}</div><div class="product-price">${money(pr)}</div><div class="product-stock ${sc}">${qty} in stock</div></div>`})}$('productsGrid').innerHTML=html||'<div class="empty-state" style="grid-column:1/-1"><span>ğŸ“¦</span><p>No products found</p></div>'}
function addToCart(id){const p=DATA.products.find(x=>x.id===id);if(!p||num(p.quantity)===0)return;const pr=saleMode==='wholesale'&&num(p.wholesale_price)>0?num(p.wholesale_price):num(p.price);const ex=cart.find(c=>c.productId===id);if(ex){if(ex.qty<num(p.quantity)){ex.qty++;ex.total=ex.qty*ex.price}else{toast('Not enough stock','error');return}}else{cart.push({productId:id,name:p.name,price:pr,costPrice:num(p.cost_price),qty:1,total:pr,image:p.image_url})}renderCart();toast('Added to cart','success')}
function addBundleToCart(id){const b=DATA.bundles.find(x=>x.id===id);if(!b)return;const ex=cart.find(c=>c.bundleId===id);if(ex){ex.qty++;ex.total=ex.qty*ex.price}else{let cost=0;(b.bundle_items||[]).forEach(i=>{if(i.products)cost+=num(i.products.cost_price)*num(i.quantity)});cart.push({bundleId:id,name:b.name,price:num(b.bundle_price),costPrice:cost,qty:1,total:num(b.bundle_price),isBundle:true,bundleItems:b.bundle_items})}renderCart();toast('Bundle added','success')}
function renderCart(){const cnt=cart.reduce((a,c)=>a+c.qty,0);$('cartBadge').textContent=cnt;$('cartCount').textContent=cnt;if(cart.length===0){$('cartBody').innerHTML='<div class="cart-empty"><span>ğŸ›’</span><p>Your cart is empty</p></div>';$('checkoutBtn').disabled=true}else{$('cartBody').innerHTML=cart.map((c,i)=>{const img=c.image?`<img src="${c.image}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`:(c.isBundle?'ğŸ':'ğŸ“¦');return`<div class="cart-item"><div class="cart-item-img">${img}</div><div class="cart-item-info"><div class="cart-item-name">${c.name}</div><div class="cart-item-price">${money(c.price)} Ã— ${c.qty} = ${money(c.total)}</div></div><div class="cart-item-qty"><button onclick="updateCartQty(${i},-1)">âˆ’</button><span>${c.qty}</span><button onclick="updateCartQty(${i},1)">+</button></div><button class="cart-item-del" onclick="removeFromCart(${i})">âœ•</button></div>`}).join('');$('checkoutBtn').disabled=false}updateCartTotals()}
function updateCartQty(i,d){const c=cart[i];if(!c)return;const nq=c.qty+d;if(nq<=0){cart.splice(i,1)}else{if(c.productId){const p=DATA.products.find(x=>x.id===c.productId);if(p&&nq>num(p.quantity)){toast('Not enough stock','error');return}}c.qty=nq;c.total=c.qty*c.price}renderCart()}
function removeFromCart(i){cart.splice(i,1);renderCart()}
function clearCart(){if(cart.length===0)return;if(!confirm('Clear cart?'))return;cart=[];renderCart()}
function updateCartTotals(){const sub=cart.reduce((a,c)=>a+c.total,0);const disc=num($('cartDiscount').value);$('cartSubtotal').textContent=money(sub);$('cartTotal').textContent=money(sub-disc)}
function openCart(){$('cartOverlay').classList.add('show');$('cartDrawer').classList.add('show')}
function closeCart(){$('cartOverlay').classList.remove('show');$('cartDrawer').classList.remove('show')}
function openPaymentModal(){if(cart.length===0)return;const sub=cart.reduce((a,c)=>a+c.total,0);const disc=num($('cartDiscount').value);$('paymentMethod').value='Cash';$('paymentTotal').textContent=money(sub-disc);openModal('paymentModal')}
async function completeSale(){showLoader('Processing...');try{const sub=cart.reduce((a,c)=>a+c.total,0);const disc=num($('cartDiscount').value);const tot=sub-disc;const profit=cart.reduce((a,c)=>a+((c.price-c.costPrice)*c.qty),0)-disc;const rec='RCP'+today().replace(/-/g,'')+'-'+Math.random().toString(36).substr(2,4).toUpperCase();const ph=$('cartPhone').value.trim()||null;const{data:sale,error}=await supabase.from('sales').insert({receipt_no:rec,subtotal:sub,discount:disc,total:tot,profit,payment_method:$('paymentMethod').value,customer_phone:ph,sale_type:saleMode==='wholesale'?'Wholesale':'Retail',cashier_name:currentUser?.name,sale_date:new Date().toISOString()}).select().single();if(error)throw error;for(const c of cart){await supabase.from('sale_items').insert({sale_id:sale.id,product_id:c.productId||null,bundle_id:c.bundleId||null,name:c.name,quantity:c.qty,price:c.price,cost_price:c.costPrice,line_total:c.total,is_bundle:c.isBundle||false});if(c.productId){const p=DATA.products.find(x=>x.id===c.productId);if(p)await supabase.from('products').update({quantity:Math.max(0,p.quantity-c.qty)}).eq('id',c.productId)}else if(c.bundleItems){for(const bi of c.bundleItems){const p=DATA.products.find(x=>x.id===bi.product_id);if(p)await supabase.from('products').update({quantity:Math.max(0,p.quantity-(bi.quantity*c.qty))}).eq('id',bi.product_id)}}}if(ph){const{data:ex}=await supabase.from('customers').select('*').eq('phone',ph).single();if(ex)await supabase.from('customers').update({visits:(ex.visits||0)+1,total_spent:num(ex.total_spent)+tot,last_visit:new Date().toISOString()}).eq('id',ex.id);else await supabase.from('customers').insert({phone:ph,visits:1,total_spent:tot,last_visit:new Date().toISOString()})}hideLoader();toast('Sale completed! '+rec,'success');cart=[];$('cartPhone').value='';$('cartDiscount').value=0;renderCart();closeModal('paymentModal');closeCart();loadAllData()}catch(e){hideLoader();console.error(e);toast('Error processing sale','error')}}
function renderReceipts(){const q=($('searchReceipts')?.value||'').toLowerCase();const list=DATA.sales.filter(s=>!s.voided&&(s.receipt_no||'').toLowerCase().includes(q));$('receiptsTable').innerHTML=list.length?list.map(s=>`<tr><td><strong>${s.receipt_no}</strong></td><td>${formatDate(s.sale_date)}</td><td style="font-weight:700;color:#3b82f6">${money(s.total)}</td><td><button class="btn btn-gray btn-sm" onclick="alert('Receipt: ${s.receipt_no}')">ğŸ‘ï¸</button></td></tr>`).join(''):'<tr><td colspan="4"><div class="empty-state"><span>ğŸ§¾</span><p>No receipts</p></div></td></tr>'}
function renderProductsList(){const q=($('searchProductsList')?.value||'').toLowerCase();const list=DATA.products.filter(p=>p.name.toLowerCase().includes(q));$('productsTable').innerHTML=list.length?list.map(p=>{const img=p.image_url?`<img src="${p.image_url}" style="width:40px;height:40px;object-fit:cover;border-radius:6px">`:'ğŸ“¦';const qty=num(p.quantity);const sc=qty===0?'#ef4444':qty<=5?'#f59e0b':'#22c55e';return`<tr><td>${img}</td><td><strong>${p.name}</strong><br><small style="color:#94a3b8">${p.category||'-'}</small></td><td style="color:#3b82f6;font-weight:700">${money(p.price)}</td><td style="color:${sc};font-weight:700">${qty}</td><td><button class="btn btn-gray btn-sm" onclick="editProduct('${p.id}')">âœï¸</button> <button class="btn btn-red btn-sm" onclick="deleteProduct('${p.id}')">ğŸ—‘ï¸</button></td></tr>`}).join(''):'<tr><td colspan="5"><div class="empty-state"><span>ğŸ“¦</span><p>No products</p></div></td></tr>'}
function openProductModal(){$('productModalTitle').textContent='Add Product';$('editProductId').value='';$('productName').value='';$('productCategory').value='';$('productCost').value='';$('productPrice').value='';$('productWholesale').value='';$('productStock').value='';currentImage='';existingImage='';resetImageUpload();openModal('productModal')}
function editProduct(id){const p=DATA.products.find(x=>x.id===id);if(!p)return;$('productModalTitle').textContent='Edit Product';$('editProductId').value=p.id;$('productName').value=p.name;$('productCategory').value=p.category||'';$('productCost').value=p.cost_price||'';$('productPrice').value=p.price;$('productWholesale').value=p.wholesale_price||'';$('productStock').value=p.quantity;if(p.image_url){existingImage=p.image_url;$('imagePreview').src=p.image_url;$('imagePreview').style.display='block';$('imageIcon').style.display='none';$('imageText').style.display='none';$('imageUpload').classList.add('has-image')}else{resetImageUpload()}openModal('productModal')}
function handleImageUpload(inp){const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{currentImage=e.target.result;$('imagePreview').src=currentImage;$('imagePreview').style.display='block';$('imageIcon').style.display='none';$('imageText').style.display='none';$('imageUpload').classList.add('has-image')};r.readAsDataURL(f)}
function resetImageUpload(){currentImage='';existingImage='';$('imagePreview').style.display='none';$('imageIcon').style.display='block';$('imageText').style.display='block';$('imageUpload').classList.remove('has-image');$('imageInput').value=''}
async function saveProduct(){const id=$('editProductId').value;const data={name:$('productName').value.trim(),category:$('productCategory').value.trim()||null,cost_price:num($('productCost').value),price:num($('productPrice').value),wholesale_price:num($('productWholesale').value)||null,quantity:num($('productStock').value)};if(!data.name){toast('Enter product name','error');return}if(!data.price){toast('Enter product price','error');return}if(currentImage)data.image_url=currentImage;else if(existingImage)data.image_url=existingImage;showLoader('Saving...');let err;if(id){({error:err}=await supabase.from('products').update(data).eq('id',id))}else{({error:err}=await supabase.from('products').insert(data))}hideLoader();if(err){console.error(err);toast('Error saving product','error')}else{closeModal('productModal');loadAllData();toast('Product saved!','success')}}
async function deleteProduct(id){if(!confirm('Delete this product?'))return;showLoader('Deleting...');await supabase.from('products').delete().eq('id',id);hideLoader();loadAllData();toast('Product deleted','success')}
function renderBundles(){$('bundlesTable').innerHTML=DATA.bundles.length?DATA.bundles.map(b=>{const items=(b.bundle_items||[]).map(i=>`${i.quantity}x ${i.products?.name||'?'}`).join(', ');return`<tr><td><strong>${b.name}</strong></td><td><small style="color:#94a3b8">${items||'No items'}</small></td><td style="color:#3b82f6;font-weight:700">${money(b.bundle_price)}</td><td><button class="btn btn-gray btn-sm" onclick="editBundle('${b.id}')">âœï¸</button> <button class="btn btn-red btn-sm" onclick="deleteBundle('${b.id}')">ğŸ—‘ï¸</button></td></tr>`}).join(''):'<tr><td colspan="4"><div class="empty-state"><span>ğŸ</span><p>No bundles</p></div></td></tr>'}
function openBundleModal(){$('editBundleId').value='';$('bundleName').value='';$('bundlePrice').value='';bundleProducts=[];updateBundleProductSelect();renderBundleItems();openModal('bundleModal')}
function editBundle(id){const b=DATA.bundles.find(x=>x.id===id);if(!b)return;$('editBundleId').value=b.id;$('bundleName').value=b.name;$('bundlePrice').value=b.bundle_price;bundleProducts=(b.bundle_items||[]).map(i=>({productId:i.product_id,quantity:i.quantity,name:i.products?.name||'?'}));updateBundleProductSelect();renderBundleItems();openModal('bundleModal')}
function updateBundleProductSelect(){$('bundleProductSelect').innerHTML='<option value="">Select product...</option>'+DATA.products.map(p=>`<option value="${p.id}">${p.name} (${money(p.price)})</option>`).join('')}
function addBundleProduct(){const sel=$('bundleProductSelect');const pid=sel.value;if(!pid)return;const p=DATA.products.find(x=>x.id===pid);if(!p)return;const ex=bundleProducts.find(x=>x.productId===pid);if(ex)ex.quantity++;else bundleProducts.push({productId:pid,quantity:1,name:p.name});sel.value='';renderBundleItems()}
function renderBundleItems(){$('bundleItemsList').innerHTML=bundleProducts.length?bundleProducts.map((b,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:8px;margin-bottom:6px"><span style="flex:1">${b.name}</span><input type="number" value="${b.quantity}" min="1" style="width:50px;height:32px;text-align:center;border:1px solid #e2e8f0;border-radius:6px" onchange="bundleProducts[${i}].quantity=parseInt(this.value)||1"><button onclick="bundleProducts.splice(${i},1);renderBundleItems()" style="width:28px;height:28px;background:#fee2e2;color:#ef4444;border:none;border-radius:6px;cursor:pointer">âœ•</button></div>`).join(''):'<p style="color:#94a3b8;text-align:center;padding:16px">No items added</p>'}
async function saveBundle(){const id=$('editBundleId').value;const data={name:$('bundleName').value.trim(),bundle_price:num($('bundlePrice').value),active:true};if(!data.name){toast('Enter bundle name','error');return}if(!bundleProducts.length){toast('Add products to bundle','error');return}if(!data.bundle_price){toast('Enter bundle price','error');return}showLoader('Saving...');try{let bid=id;if(id){await supabase.from('bundles').update(data).eq('id',id);await supabase.from('bundle_items').delete().eq('bundle_id',id)}else{const{data:nb}=await supabase.from('bundles').insert(data).select().single();bid=nb.id}await supabase.from('bundle_items').insert(bundleProducts.map(bp=>({bundle_id:bid,product_id:bp.productId,quantity:bp.quantity})));hideLoader();closeModal('bundleModal');loadAllData();toast('Bundle saved!','success')}catch(e){hideLoader();console.error(e);toast('Error saving bundle','error')}}
async function deleteBundle(id){if(!confirm('Delete this bundle?'))return;showLoader('Deleting...');await supabase.from('bundles').delete().eq('id',id);hideLoader();loadAllData();toast('Bundle deleted','success')}
function renderCustomers(){const q=($('searchCustomers')?.value||'').toLowerCase();const list=DATA.customers.filter(c=>(c.phone||'').includes(q)||(c.name||'').toLowerCase().includes(q));const tot=DATA.customers.length,rep=DATA.customers.filter(c=>c.visits>1).length,rev=DATA.customers.reduce((a,c)=>a+num(c.total_spent),0),avg=tot>0?rev/tot:0;$('custTotal').textContent=tot;$('custRepeat').textContent=rep;$('custRevenue').textContent=money(rev);$('custAvg').textContent=money(avg);$('customersTable').innerHTML=list.length?list.map(c=>`<tr><td>ğŸ“± ${c.phone||'-'}</td><td>${c.visits||1}</td><td style="font-weight:700;color:#3b82f6">${money(c.total_spent)}</td><td>${formatDate(c.last_visit)}</td></tr>`).join(''):'<tr><td colspan="4"><div class="empty-state"><span>ğŸ‘¥</span><p>No customers yet</p></div></td></tr>'}
function renderExpenses(){const mo=new Date().toISOString().slice(0,7);const mExp=DATA.expenses.filter(e=>e.expense_date&&e.expense_date.startsWith(mo));$('expenseMonth').textContent=money(mExp.reduce((a,e)=>a+num(e.amount),0));$('expensesTable').innerHTML=DATA.expenses.length?DATA.expenses.slice(0,50).map(e=>`<tr><td>${formatDate(e.expense_date)}</td><td><span class="badge badge-red">${e.category}</span></td><td style="font-weight:700;color:#ef4444">${money(e.amount)}</td><td><button class="btn btn-red btn-sm" onclick="deleteExpense('${e.id}')">ğŸ—‘ï¸</button></td></tr>`).join(''):'<tr><td colspan="4"><div class="empty-state"><span>ğŸ’¸</span><p>No expenses</p></div></td></tr>'}
function openExpenseModal(){$('expenseDate').value=today();$('expenseCategory').value='Utilities';$('expenseDesc').value='';$('expenseAmount').value='';openModal('expenseModal')}
async function saveExpense(){const data={expense_date:$('expenseDate').value,category:$('expenseCategory').value,description:$('expenseDesc').value.trim(),amount:num($('expenseAmount').value)};if(!data.amount){toast('Enter amount','error');return}showLoader('Saving...');const{error}=await supabase.from('expenses').insert(data);hideLoader();if(error){console.error(error);toast('Error saving expense','error')}else{closeModal('expenseModal');loadAllData();toast('Expense added!','success')}}
async function deleteExpense(id){if(!confirm('Delete this expense?'))return;showLoader('Deleting...');await supabase.from('expenses').delete().eq('id',id);hideLoader();loadAllData();toast('Expense deleted','success')}
function initReports(){const now=new Date();$('reportFrom').value=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];$('reportTo').value=today();loadReports()}
function loadReports(){const fr=$('reportFrom').value,to=$('reportTo').value;if(!fr||!to)return;const sales=DATA.sales.filter(s=>{const d=s.sale_date?.split('T')[0];return d>=fr&&d<=to&&!s.voided});const exps=DATA.expenses.filter(e=>{const d=e.expense_date;return d>=fr&&d<=to});const tSales=sales.reduce((a,s)=>a+num(s.total),0);const tProfit=sales.reduce((a,s)=>a+num(s.profit),0);const tExp=exps.reduce((a,e)=>a+num(e.amount),0);const net=tProfit-tExp;$('repSales').textContent=money(tSales);$('repProfit').textContent=money(tProfit);$('repExpenses').textContent=money(tExp);$('repNet').textContent=money(net);$('repNet').style.color=net>=0?'#22c55e':'#ef4444';const ps={};sales.forEach(s=>(s.sale_items||[]).filter(i=>!i.is_bundle).forEach(i=>{if(!ps[i.name])ps[i.name]={name:i.name,qty:0,tot:0};ps[i.name].qty+=i.quantity;ps[i.name].tot+=i.line_total}));const top=Object.values(ps).sort((a,b)=>b.tot-a.tot).slice(0,5);$('topProducts').innerHTML=top.length?top.map((p,i)=>`<div style="display:flex;align-items:center;gap:10px;padding:10px;background:#f8fafc;border-radius:10px;margin-bottom:8px"><div style="width:28px;height:28px;background:${i===0?'linear-gradient(135deg,#f59e0b,#d97706)':'#3b82f6'};color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700">${i+1}</div><div style="flex:1"><strong>${p.name}</strong><br><small style="color:#94a3b8">${p.qty} sold</small></div><strong style="color:#3b82f6">${money(p.tot)}</strong></div>`).join(''):'<p style="color:#94a3b8;text-align:center">No sales data</p>'}
function renderStaff(){$('staffTable').innerHTML=DATA.staff.length?DATA.staff.map(s=>`<tr><td><strong>${s.name}</strong></td><td><span class="badge ${s.role==='Admin'?'badge-blue':'badge-orange'}">${s.role}</span></td><td><button class="btn btn-gray btn-sm" onclick="editStaff('${s.id}')">âœï¸</button> <button class="btn btn-red btn-sm" onclick="deleteStaff('${s.id}')">ğŸ—‘ï¸</button></td></tr>`).join(''):'<tr><td colspan="3"><div class="empty-state"><span>ğŸ‘¤</span><p>No staff</p></div></td></tr>'}
function openStaffModal(){$('editStaffId').value='';$('staffName').value='';$('staffRole').value='Cashier';$('staffPin').value='';openModal('staffModal')}
function editStaff(id){const s=DATA.staff.find(x=>x.id===id);if(!s)return;$('editStaffId').value=s.id;$('staffName').value=s.name;$('staffRole').value=s.role;$('staffPin').value=s.pin;openModal('staffModal')}
async function saveStaff(){const id=$('editStaffId').value;const data={name:$('staffName').value.trim(),role:$('staffRole').value,pin:$('staffPin').value,active:true};if(!data.name){toast('Enter name','error');return}if(!data.pin||data.pin.length!==4){toast('Enter 4-digit PIN','error');return}showLoader('Saving...');let err;if(id){({error:err}=await supabase.from('staff').update(data).eq('id',id))}else{({error:err}=await supabase.from('staff').insert(data))}hideLoader();if(err){console.error(err);toast('Error saving staff','error')}else{closeModal('staffModal');loadAllData();toast('Staff saved!','success')}}
async function deleteStaff(id){if(!confirm('Delete this staff member?'))return;showLoader('Deleting...');await supabase.from('staff').update({active:false}).eq('id',id);hideLoader();loadAllData();toast('Staff deleted','success')}
function updateOrderBadge(){const p=DATA.orders.filter(o=>o.status==='Pending').length;$('waBadgeHeader').textContent=p;$('pendingCount').textContent=p}
function filterOrders(s){orderFilter=s;document.querySelectorAll('#pageWhatsApp .cat-pill').forEach(p=>p.classList.remove('active'));event.target.classList.add('active');renderOrders()}
function renderOrders(){let list=DATA.orders;if(orderFilter!=='all')list=list.filter(o=>o.status===orderFilter);$('ordersList').innerHTML=list.length?list.map(o=>`<div class="wa-order ${o.status==='Completed'?'completed':''}"><div class="wa-order-header"><span class="wa-order-id">#${o.order_number||o.id.slice(0,8)}</span><span class="wa-order-time">${formatDateTime(o.order_date)}</span></div><div class="wa-order-customer"><div class="wa-order-avatar">ğŸ‘¤</div><div><strong>${o.customer_name||'Customer'}</strong><br><small>ğŸ“± ${o.customer_phone||'-'}</small></div></div><div class="wa-order-items">${(o.whatsapp_order_items||[]).map(i=>`<div class="wa-order-item"><span>${i.quantity}x ${i.product_name}</span><strong>${money(i.line_total)}</strong></div>`).join('')}</div><div style="display:flex;justify-content:space-between;align-items:center"><span class="wa-order-total">${money(o.total)}</span>${o.status==='Pending'?`<div class="wa-order-actions"><button class="btn btn-green btn-sm" onclick="completeOrder('${o.id}')">âœ…</button><button class="btn btn-red btn-sm" onclick="cancelOrder('${o.id}')">âŒ</button></div>`:`<span class="badge ${o.status==='Completed'?'badge-green':'badge-red'}">${o.status}</span>`}</div></div>`).join(''):'<div class="empty-state"><span>ğŸ“±</span><p>No orders</p></div>'}
async function completeOrder(id){if(!confirm('Mark as completed?'))return;showLoader('Updating...');await supabase.from('whatsapp_orders').update({status:'Completed'}).eq('id',id);hideLoader();loadAllData();toast('Order completed!','success')}
async function cancelOrder(id){if(!confirm('Cancel this order?'))return;showLoader('Cancelling...');await supabase.from('whatsapp_orders').update({status:'Cancelled'}).eq('id',id);hideLoader();loadAllData();toast('Order cancelled','success')}
document.addEventListener('DOMContentLoaded',async()=>{await loadAllData();supabase.channel('changes').on('postgres_changes',{event:'*',schema:'public',table:'products'},()=>loadAllData()).on('postgres_changes',{event:'*',schema:'public',table:'whatsapp_orders'},()=>loadAllData()).subscribe();setInterval(()=>{if(!document.hidden)loadAllData()},60000)});
</script>
</body>
</html>
